(function(a){function B(a){var b=this;b.treeview=a,b._draggable=new c.Draggable(a.element,{filter:"div:not(.t-state-disabled) .t-in",hint:function(a){return y.dragClue({text:a.text()})},dragstart:g(b.dragstart,b),drag:g(b.drag,b),dragend:g(b.dragend,b)})}var b=window.kendo,c=b.ui,d=a.extend,e=b.template,f=c.Component,g=a.proxy,h="select",i="expand",j="collapse",k="dragstart",l="drag",m="nodeDragCancelled",n="drop",o="dragend",p="click",q="visibility",r="t-state-hover",s="t-treeview",t="t-item",u=":visible",v=".t-item",w=">.t-group,>.t-animation-container>.t-group",x=w+",>.t-content,>.t-animation-container>.t-content",y,z,A;y={dragClue:e("<div class='t-header t-drag-clue'><span class='t-icon t-drag-status'></span><#= text #></div>"),group:e("<ul class='<#= groupCssClass(group) #>'<#= groupAttributes(group) #>><#= renderItems(data); #></ul>"),itemWrapper:e("<div class='<#= cssClass(group, item) #>'><#= toggleButton(data) #><<#= tag(item) #> class='<#= textClass(item) #>'<#= textAttributes(item) #>><#= image(item) #><#= sprite(item) #><#= text(item) #></<#= tag(item) #>></div>"),item:e("<li class='<#= wrapperCssClass(group, item) #>'><#= itemWrapper(data) #><# if (item.items) { #><#= subGroup({ items: item.items, treeview: treeview, group: { expanded: item.expanded } }) #><# } #></li>"),image:e("<img class='t-image' alt='' src='<#= imageUrl #>' />"),toggleButton:e("<span class='<#= toggleButtonClass(item) #>'></span>"),sprite:e("<span class='t-sprite <#= spriteCssClass #>'></span>"),empty:e("")},A=f.extend({init:function(b,c){var d=this,b=a(b),e=".t-in:not(.t-state-selected,.t-state-disabled)",m;c=a.isArray(c)?(m=!0,{dataSource:c}):c,f.prototype.init.call(d,b,c),c=d.options,c.animation===!1&&(c.animation={expand:{show:!0,effects:{}},collapse:{hide:!0,effects:{}}}),b.hasClass(s)?(d.wrapper=b,d.root=b.children("ul").eq(0)):(d._wrapper(),d.root.length?d._group(d.wrapper):d.root=d.wrapper.html(A.renderGroup({items:c.dataSource,group:{firstLevel:!0,expanded:!0},treeview:{}})).children("ul")),d.wrapper.delegate(".t-in.t-state-selected","mouseenter",function(a){a.preventDefault()}).delegate(e,"mouseenter",function(){a(this).addClass(r)}).delegate(e,"mouseleave",function(){a(this).removeClass(r)}).delegate(e,p,g(d._nodeClick,d)).delegate("div:not(.t-state-disabled) .t-in","dblclick",g(d._toggleButtonClick,d)).delegate(".t-plus,.t-minus",p,g(d._toggleButtonClick,d)),c.dragAndDrop&&(d.bind([k,l,n,o],c),d.dragging=new B(d)),d.bind([i,j,h],c)},options:{dataSource:{},animation:{expand:{effects:"expandVertical",duration:200,show:!0},collapse:{duration:100,show:!1,hide:!0}}},_trigger:function(a,b){return this.trigger(a,{node:b.closest(v)[0]})},_toggleButtonClick:function(b){this.toggle(a(b.target).closest(v))},_nodeClick:function(b){var c=this,d=a(b.target),e=d.closest(v).find(x),f=d.attr("href"),g;f?g=f=="#"||f.indexOf("#"+this.element.id+"-")>=0:g=e.length>0&&e.children().length==0,g&&b.preventDefault(),!d.hasClass(".t-state-selected")&&!c._trigger("select",d)&&c.select(d)},_wrapper:function(){var a=this,b=a.element,c,d,e="t-widget t-treeview t-reset";b.is("div")?(c=b.addClass(e),d=c.children("ul").eq(0)):(c=b.wrap('<div class="'+e+'" />').parent(),d=b),a.wrapper=c,a.root=d},_group:function(a){var b=this,c=a.hasClass(s),d={firstLevel:c,expanded:c||a.data("expanded")===!0},e=a.find("> ul");e.addClass(z.groupCssClass(d)).css("display",d.expanded?"":"none"),b._nodes(e,d)},_nodes:function(b,c){var e=this,f=b.find("> li"),g;c=d({length:f.length},c),f.each(function(b,d){d=a(d),g={index:b,expanded:d.data("expanded")===!0},e._updateNodeHtml(d),e._updateNodeClasses(d,c,g),e._group(d)})},_updateNodeHtml:function(b){var c=b.find(">div"),d=b.find(">ul"),e=c.find(">.t-icon"),f=c.find(">.t-in");c.length||(c=a("<div />").prependTo(b));if(!e.length&&d.length)e=a("<span class='t-icon' />").prependTo(c);else if(!d.length||!d.children().length)e.remove(),d.remove();if(!f.length){f=a("<span class='t-in' />").appendTo(c)[0],currentNode=c[0].nextSibling,f=c.find(".t-in")[0];while(currentNode&&currentNode.nodeName.toLowerCase()!="ul")tmp=currentNode,currentNode=currentNode.nextSibling,f.appendChild(tmp)}},_updateNodeClasses:function(a,b,c){var d=a.find(">div"),e=a.find(">ul");c||(c={expanded:e.css("display")!="none",index:a.index(),enabled:!d.find(">.t-in").hasClass("t-state-disabled")}),b||(b={firstLevel:a.parent().parent().hasClass(s),length:a.parent().children().length}),a.removeClass("t-first t-last").addClass(z.wrapperCssClass(b,c)),d.removeClass("t-top t-mid t-bot").addClass(z.cssClass(b,c)),e.length&&(d.find(">.t-icon").removeClass("t-plus t-minus t-plus-disabled t-minus-disabled").addClass(z.toggleButtonClass(c)),e.addClass("t-group"))},_processNodes:function(b,c){var d=this;d.element.find(b).each(function(b,e){c.call(d,b,a(e).closest(v))})},expand:function(a){this._processNodes(a,function(a,b){var c=b.find(x);c.length>0&&!c.is(u)&&this.toggle(b)})},collapse:function(a){this._processNodes(a,function(a,b){var c=b.find(x);c.length>0&&c.is(u)&&this.toggle(b)})},enable:function(a,b){b=arguments.length==2?!!b:!0,this._processNodes(a,function(a,c){var d=!c.find(x).is(u);b||(this.collapse(c),d=!0),c.find(">div").find(">.t-in").toggleClass("t-state-default",b).toggleClass("t-state-disabled",!b).end().find(">.t-icon").toggleClass("t-plus",d&&b).toggleClass("t-plus-disabled",d&&!b).toggleClass("t-minus",!d&&b).toggleClass("t-minus-disabled",!d&&!b)})},select:function(b){var c=this.element;if(arguments.length==0)return c.find(".t-state-selected").closest(v);b=a(b).closest(v),b.length&&(c.find(".t-in").removeClass("t-state-hover t-state-selected"),b.find(".t-in:first").addClass("t-state-selected"))},toggle:function(a){if(a.find(".t-minus,.t-plus").length!=0){if(a.find("> div > .t-state-disabled").length)return;var b=this,c=a.find(x),e=!c.is(u),f=b.options.animation||{},g=f.expand,h=f.collapse,i=h&&"effects"in h;if(c.data("animating"))return;e||(g=i?h:d({reverse:!0},g,{show:!1,hide:!0})),c.children().length>0&&(b._trigger(e?"expand":"collapse",a)||(a.find("> div > .t-icon").toggleClass("t-minus",e).toggleClass("t-plus",!e),e||c.css("height",c.height()).css("height"),c.kendoStop(!0,!0).kendoAnimate(d(g,{complete:function(){e&&c.css("height","")}}))))}},text:function(b){return a(b).closest(v).find(">div>.t-in").text()},_insertNode:function(b,c,e,f,g){var h=this,i=f.children().length+1,j=a.isPlainObject(b),k={firstLevel:e.hasClass(s),expanded:!0,length:i},l;j?l=a(A.renderItem({group:k,item:d(b,{index:c})})):(l=a(b),l.closest(".t-treeview")[0]==h.wrapper[0]&&h.remove(l)),f.length||(f=a(A.renderGroup({group:k})).appendTo(e)),g(l,f),e.hasClass("t-item")&&(h._updateNodeHtml(e),h._updateNodeClasses(e)),j||h._updateNodeClasses(l),h._updateNodeClasses(l.prev()),h._updateNodeClasses(l.next());return l},insertAfter:function(a,b){var c=b.parent();return this._insertNode(a,b.index()+1,c.parent(),c,function(a,c){a.insertAfter(b)})},insertBefore:function(a,b){var c=b.parent();return this._insertNode(a,b.index(),c.parent(),c,function(a,c){a.insertBefore(b)})},append:function(a,b){b=b||this.element;var c=b.find(w);return this._insertNode(a,c.children().length,b,c,function(a,b){a.appendTo(b)})},remove:function(b){b=a(b);var c=this,d=b.parent().parent(),e=b.prev(),f=b.next();b.remove(),d.hasClass("t-item")&&(c._updateNodeHtml(d),c._updateNodeClasses(d)),c._updateNodeClasses(e),c._updateNodeClasses(f)},findByText:function(b){var c;a(".t-in",this.element).each(function(){var d=a(this);if(d.text()==b){c=d.closest(v);return!1}});return c}}),B.prototype={_hintStatus:function(b){var c=this._draggable.hint.find(".t-drag-status")[0];if(b)c.className="t-icon t-drag-status "+b;else return a.trim(c.className.replace(/t-(icon|drag-status)/g,""))},dragstart:function(b){var c=this,d=c.treeview,e=c.sourceNode=b.currentTarget.closest(v);if(d.trigger(k,{sourceNode:e[0]}))return!1;c.dropHint=a("<div class='t-drop-hint' />").css(q,"hidden").appendTo(d.element)},drag:function(c){var d=this,e=d.treeview,f=d.sourceNode,g=d.dropTarget=a(b.eventTarget(c)),h,i,j,k,m,n,o,p,s,t;a.contains(e.wrapper[0],g[0])?a.contains(f[0],g[0])?h="t-denied":(h="t-insert-middle",d.dropHint.css(q,"visible"),i=g.closest(".t-top,.t-mid,.t-bot"),i.length>0&&(k=i.outerHeight(),m=i.offset().top,n=g.closest(".t-in"),o=k/(n.length>0?4:2),p=c.pageY<m+o,s=m+k-o<c.pageY,t=n.length>0&&!p&&!s,n.toggleClass(r,t),d.dropHint.css(q,t?"hidden":"visible"),t?h="t-add":(j=i.position(),j.top+=p?0:k,d.dropHint.css(j)[p?"prependTo":"appendTo"](g.closest(v).find("> div:first")),p&&i.hasClass("t-top")&&(h="t-insert-top"),s&&i.hasClass("t-bot")&&(h="t-insert-bottom")))):h="t-denied",e.trigger(l,{sourceNode:f[0],dropTarget:g[0],pageY:c.pageY,pageX:c.pageX,statusClass:h.substring(2),setStatusClass:function(a){h=a}}),h.indexOf("t-insert")!=0&&d.dropHint.css(q,"hidden"),d._hintStatus(h)},dragend:function(a){var c=this,d=c.treeview,e="over",f=c.sourceNode,g,h,i;if(a.keyCode==b.keys.ESC)c.dropHint.remove();else{c.dropHint.css(q)=="visible"?(e=c.dropHint.prevAll(".t-in").length>0?"after":"before",g=c.dropHint.closest(v)):c.dropTarget&&(g=c.dropTarget.closest(v)),h=c._hintStatus()!="t-denied",i=d.trigger(n,{sourceNode:f[0],destinationNode:g[0],valid:h,setValid:function(a){h=a},dropTarget:a.target,dropPosition:e}),c.dropHint.remove();if(!h||i){c._draggable.dropped=h;return}c._draggable.dropped=!0,e=="over"?(d.append(f,g),d.expand(g)):e=="before"?d.insertBefore(f,g):e=="after"&&d.insertAfter(f,g),d.trigger(o,{sourceNode:f[0],destinationNode:g[0],dropPosition:e})}}},d(A,{renderItem:function(a){a=d({treeview:{},group:{}},a);var b=y.empty,c=a.item,e=a.treeview;return y.item(d(a,{image:c.imageUrl?y.image:b,sprite:c.spriteCssClass?y.sprite:b,itemWrapper:y.itemWrapper,toggleButton:c.items?y.toggleButton:b,subGroup:A.renderGroup},z))},renderGroup:function(a){return y.group(d({renderItems:function(a){var b="",c=0,e=a.items,f=e?e.length:0,g=d({length:f},a.group);for(;c<f;c++)b+=A.renderItem(d(a,{group:g,item:d({index:c},e[c])}));return b}},a,z))}}),z={wrapperCssClass:function(a,b){var c="t-item",d=b.index;a.firstLevel&&d==0&&(c+=" t-first"),d==a.length-1&&(c+=" t-last");return c},cssClass:function(a,b){var c="",d=b.index,e=a.length-1;a.firstLevel&&d==0&&(c+="t-top "),d==0&&d!=e?c+="t-top":d==e?c+="t-bot":c+="t-mid";return c},textClass:function(a){var b="t-in";a.enabled===!1&&(b+=" t-state-disabled"),a.selected===!0&&(b+=" t-state-selected");return b},textAttributes:function(a){return a.url?" href='"+a.url+"'":""},toggleButtonClass:function(a){var b="t-icon";a.expanded!==!0?b+=" t-plus":b+=" t-minus",a.enabled===!1&&(b+="-disabled");return b},text:function(a){return a.encoded===!1?a.text:b.htmlEncode(a.text)},tag:function(a){return a.url?"a":"span"},groupAttributes:function(a){return a.expanded!==!0?" style='display:none'":""},groupCssClass:function(a){var b="t-group";a.firstLevel&&(b+=" t-treeview-lines");return b}},c.plugin("TreeView",A)})(jQuery)