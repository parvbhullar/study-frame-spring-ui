<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd" >
<sqlMap namespace="CORE_ADEXTEND">
    <resultMap id="ibatorgenerated_BaseResultMap" class="com.mitian.airad.model.CoreAdExtend">
        <!--
            WARNING - This element is automatically generated by Apache iBATIS ibator, do not modify. This element was
            generated on Sat Mar 12 17:16:12 CST 2011.
        -->
        <result column="AD_ID" property="adId" jdbcType="INTEGER" />
        <result column="WAP_ID" property="wapId" jdbcType="INTEGER" />
        <result column="AD_GROUP_ID" property="adGroupId" jdbcType="INTEGER" />
        <result column="RICH_ID" property="richId" jdbcType="INTEGER" />
        <result column="BANNER_ID" property="bannerId" jdbcType="INTEGER" />
        <result column="AD_NAME" property="adName" jdbcType="VARCHAR" />
        <result column="AD_DETAIL_INFO" property="adDetailInfo" jdbcType="VARCHAR" />
        <result column="SUSPEND_TYPE" property="suspendType" jdbcType="CHAR" />
        <result column="AD_OFFER" property="adOffer" jdbcType="DECIMAL" />
        <result column="ADD_OPER" property="addOper" jdbcType="VARCHAR" />
        <result column="ADD_TIME" property="addTime" jdbcType="VARCHAR" />
        <result column="UPD_OPER" property="updOper" jdbcType="VARCHAR" />
        <result column="UPD_TIME" property="updTime" jdbcType="VARCHAR" />
        <result column="DEL_OPER" property="delOper" jdbcType="VARCHAR" />
        <result column="DEL_TIME" property="delTime" jdbcType="VARCHAR" />
        <result column="DEL_FLAG" property="delFlag" jdbcType="CHAR" />
        <result column="MEMBER_ID" property="memberId" jdbcType="LONG" />
        <result column="CAMPAIGN_ID" property="campaignId" jdbcType="INTEGER" />
        <result column="SHOWNUM" property="showNum" jdbcType="INTEGER" />
        <result column="SELFMONEY" property="selfMoney" jdbcType="DECIMAL" />
        <result column="AGENTMONEY" property="agentMoney" jdbcType="DECIMAL" />
        <result column="START_TIME" property="startTime" jdbcType="VARCHAR" />
        <result column="END_TIME" property="endTime" jdbcType="VARCHAR" />
        <result column="BUGGET_DAY" property="budgetDay" jdbcType="DECIMAL" />
    </resultMap>
    <!-- 根据省市区 ,查询出广告  
            广告满足条件 :1.用户的账户余额 或 代理商余额 大于0 
      2.当日预算 大于 当日已经支付的  账户金额+代理商金额
      3.该广告的发布日期 在 广告活动日期之内
      4.该广告 属于 此 省市区
      5.该广告的状态为正常 (未冻结,未暂停,未删除)
      6.该广告发布人状态为正常
     -->
    
    <select id="ibatorgenerated_selectCoreAdByPlace" resultMap="ibatorgenerated_BaseResultMap" parameterClass="java.util.HashMap">
       <![CDATA[
SELECT * from(
select fourTb1.*,IFNULL(fourTb2.SELFPAYMONEY,0) SELFPAYMONEY,IFNULL(fourTb3.AGENTPAYMONEY,0) AGENTPAYMONEY,IFNULL(fourTb4.TODAYSELFPAYMONEY,0) TODAYSELFPAYMONEY,IFNULL(fourTb5.TODAYAGENTPAYMONEY,0) TODAYAGENTPAYMONEY from(

select IFNULL(threeTb1.AD_ID,'') AD_ID,IFNULL(threeTb1.MEMBER_ID,'') MEMBER_ID,IFNULL(threeTb1.WAP_ID,'') WAP_ID,IFNULL(threeTb1.AD_GROUP_ID,'') AD_GROUP_ID,IFNULL(threeTb1.RICH_ID,'') RICH_ID,IFNULL(threeTb1.BANNER_ID,'') BANNER_ID,IFNULL(threeTb1.AD_NAME,'') AD_NAME,IFNULL(threeTb1.AD_DETAIL_INFO,'') AD_DETAIL_INFO,IFNULL(threeTb1.SUSPEND_TYPE,'') SUSPEND_TYPE,IFNULL(threeTb1.AD_OFFER,0) AD_OFFER,IFNULL(threeTb1.ADD_OPER,'') ADD_OPER,IFNULL(threeTb1.ADD_TIME,'') ADD_TIME,
    IFNULL(threeTb1.UPD_OPER,'') UPD_OPER,IFNULL(threeTb1.UPD_TIME,'') UPD_TIME,IFNULL(threeTb1.DEL_OPER,'') DEL_OPER,IFNULL(threeTb1.DEL_TIME,'') DEL_TIME,IFNULL(threeTb1.DEL_FLAG,'') DEL_FLAG,IFNULL(threeTb1.SHOWNUM,0) SHOWNUM,IFNULL(threeTb1.selfMoney,0) SELFMONEY,IFNULL(threeTb1.agentMoney,0) AGENTMONEY,IFNULL(threeTb2.start_time,'') START_TIME,IFNULL(threeTb2.end_time,'') END_TIME,IFNULL(threeTb2.campaign_id,'') CAMPAIGN_ID,IFNULL(threeTb2.BUGGET_DAY,'') BUGGET_DAY  from (    

select towTb1.AD_ID,towTb1.MEMBER_ID,towTb1.WAP_ID,towTb1.AD_GROUP_ID,towTb1.RICH_ID,towTb1.BANNER_ID,towTb1.AD_NAME,towTb1.AD_DETAIL_INFO,towTb1.SUSPEND_TYPE,towTb1.AD_OFFER,towTb1.ADD_OPER,towTb1.ADD_TIME,
    towTb1.UPD_OPER,towTb1.UPD_TIME,towTb1.DEL_OPER,towTb1.DEL_TIME,towTb1.DEL_FLAG,towTb1.showNum,towTb1.campaign_id,towTb2.selfMoney,towTb3.agentMoney from (    


select tb1.AD_ID,tb1.MEMBER_ID,tb1.WAP_ID,tb1.AD_GROUP_ID,tb1.RICH_ID,tb1.BANNER_ID,tb1.AD_NAME,tb1.AD_DETAIL_INFO,tb1.SUSPEND_TYPE,tb1.AD_OFFER,tb1.ADD_OPER,tb1.ADD_TIME,
    tb1.UPD_OPER,tb1.UPD_TIME,tb1.DEL_OPER,tb1.DEL_TIME,tb1.DEL_FLAG,tb2.showNum,tb1.campaign_id from (    

select * from (
select ca.AD_ID,ca.MEMBER_ID,ca.WAP_ID,ca.AD_GROUP_ID,ca.RICH_ID,ca.BANNER_ID,ca.AD_NAME,ca.AD_DETAIL_INFO,ca.SUSPEND_TYPE,ca.AD_OFFER,ca.ADD_OPER,ca.ADD_TIME,
ca.UPD_OPER,ca.UPD_TIME,ca.DEL_OPER,ca.DEL_TIME,ca.DEL_FLAG,cag2.CAMPAIGN_ID,cag2.SUSPEND_TYPE  SUSPEND_TYPE2 ,cag2.DEL_FLAG  DEL_FLAG2,cag2.BLOCKING  BLOCKING2 from CORE_AD ca left join CORE_AD_GROUPEXTEND cag
on ca.ad_group_id = cag.ad_group_id
left join CORE_AD_GROUP cag2
on ca.ad_group_id = cag2.ad_group_id
where ca.SUSPEND_TYPE =0 and ca.DEL_FLAG = 0 and ca.BLOCKING=0 and (ca.FLAG = 4 or ca.FLAG=2) and (cag.GEOGRAPHICAL_POSITION like '%;$place$%' or cag2.ad_locl_type = 0  )and cag2.ad_tag_sp like '%$tagSp$%') tb
inner join (select member_id memMemberId,member_status memStatus,member_type memDevType,del_flag memDelFlag from CORE_MEMBER_INFO) tbMember
on tbMember.memMemberId = tb.MEMBER_ID and tbMember.memStatus<>'2' and tbMember.memDelFlag='0' and (tbMember.memDevType=1 or tbMember.memDevType=3)

) tb1 left join (select AD_ID,count(AD_ID) showNum from REQ_BANNER  group by AD_ID) tb2
on tb1.AD_ID = tb2.AD_ID

) towTb1 left join (select sum(money) selfMoney,member_id from ACC_INCOME_PAY where (TRADE_TYPE =0 or (TRADE_TYPE=5 and INCOME_PAY_TYPE = 'B')) group by member_id) towTb2
on towTb1.member_id = towTb2.member_id 
left join (select sum(money) agentMoney,member_id from ACC_INCOME_PAY where TRADE_TYPE =2 group by member_id) towTb3
on towTb1.member_id = towTb3.member_id

) threeTb1 inner join (
select SUSPEND_TYPE,DEL_FLAG,BLOCKING,start_time,end_time,campaign_id,BUGGET_DAY from CORE_CAMPAIGN
where start_time <= now() and (end_time >= now() or end_time is null)
) threeTb2
on threeTb1.campaign_id = threeTb2.campaign_id
   order by AD_OFFER DESC 
   
   ) fourTb1 left join (select sum(money) selfPayMoney,member_id from ACC_INCOME_PAY where TRADE_TYPE =3 and INCOME_PAY_TYPE ='A' group by member_id) fourTb2
on fourTb1.member_id = fourTb2.member_id LEFT JOIN (select IFNULL(sum(money),0) agentPayMoney,member_id from ACC_INCOME_PAY where TRADE_TYPE =3 and INCOME_PAY_TYPE ='B' group by member_id) fourTb3 
on fourTb1.member_id = fourTb3.member_id LEFT JOIN (select IFNULL(sum(money),0) TODAYSELFPAYMONEY,member_id from ACC_INCOME_PAY where TRADE_TYPE =3 and INCOME_PAY_TYPE ='A' and ADD_TIME >DATE_FORMAT(now(), '%Y-%m-%d 00:00:00') group by member_id) fourTb4
on fourTb1.member_id = fourTb4.member_id LEFT JOIN (select IFNULL(sum(money),0) TODAYAGENTPAYMONEY,member_id from ACC_INCOME_PAY where TRADE_TYPE =3 and INCOME_PAY_TYPE ='B' and ADD_TIME >DATE_FORMAT(now(), '%Y-%m-%d 00:00:00') group by member_id) fourTb5
on fourTb1.member_id = fourTb5.member_id
) endTb
where (SELFMONEY - SELFPAYMONEY > AD_OFFER OR AGENTMONEY - AGENTPAYMONEY >= AD_OFFER) and BUGGET_DAY - TODAYSELFPAYMONEY -TODAYAGENTPAYMONEY >= AD_OFFER AND AD_OFFER >0
]]>
    </select>
</sqlMap>