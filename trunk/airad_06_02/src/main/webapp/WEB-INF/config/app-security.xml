<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xmlns:p="http://www.springframework.org/schema/p" xmlns:context="http://www.springframework.org/schema/context"
    xmlns:aop="http://www.springframework.org/schema/aop" xmlns:tx="http://www.springframework.org/schema/tx"
    xsi:schemaLocation="
      http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
      http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context-3.0.xsd
      http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-3.0.xsd
      http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-3.0.xsd">
    <context:annotation-config />
    <context:component-scan base-package="com.mitian.airad.common" />


    <!-- 会员模块登录配置 start 
    <bean id="providerService" class="com.mitian.airad.common.auth.provider.ProviderService">
        <property name="cookieGenerator">
            <ref bean="cookieGenerator" />
        </property>
        <property name="providers">
            <list>
                <ref bean="daoAuthProvider" />
            </list>
        </property>
    </bean>
     <bean id="daoAuthProvider" class="com.mitian.airad.common.auth.provider.jdbc.JDBCAuthProvider" />
    -->
<!--    <bean id="cookieGenerator" class="com.mitian.airad.common.auth.cookie.CookieGenerator">-->
<!--        <property name="cookieSecure" value="false" />-->
<!--        <property name="cookieMaxAge" value="-1" />-->
<!--        <property name="cookieName" value="mt" />-->
<!--        <property name="cookiePath" value="/" />-->
<!--    </bean>-->
    <bean id="lastVisitCookieGenerator" class="com.mitian.airad.common.auth.cookie.CookieGenerator">
        <property name="cookieSecure" value="false" />
        <property name="cookieMaxAge" value="-1" />
        <property name="cookieName" value="mtl" />
        <property name="cookiePath" value="/" />
    </bean>
   
    <!-- 会员模块登录配置 end -->

    <!-- 会员权限拦截过滤模块 -->
    <bean id="springSecurityFilterChain" class="com.mitian.airad.common.auth.filter.AuthFilterChainProxy">
        <property name="filters">
            <list>
<!--               <ref bean="secureChannelFilter" />-->
<!--               <ref bean="inSecureChannelFilter" />-->
                <ref bean="securityContextFilter" />
                <ref bean="timeOutCheckFilter" />
            </list>
        </property>
    </bean>
    <bean id="baseFilter" abstract="true" class="com.mitian.airad.common.auth.filter.AbstractAuthFilter">
        <property name="ignoreFirst" value="true" />
        <property name="nologinUrl" value="/register.do?xcase=inputLogin" />
        <property name="forwardToDestination" value="true" />
        <property name="contextRelative" value="false" />
        <property name="redirectToSource" value="true" />

        <!-- 反向拦截, 拦截符合正则表达式之外的 所有资源 -->
        <property name="excludeUrlProcessor">
            <ref bean="excludeUrlProcessor" />
        </property>

        <!-- 正向拦截，只拦截符合正则表达式的资源 -->
        <property name="includeUrlProcessor">
            <ref bean="includeUrlProcessor" />
        </property>
<!--        <property name="cookieGenerator">-->
<!--            <ref bean="cookieGenerator" />-->
<!--        </property>-->
    </bean>

    <!-- 安全信道选择 -->
    <bean id="secureChannelFilter" class="com.mitian.airad.common.auth.filter.SecureChannelFilter">
         <property name="ignoreFirst" value="false" />
        <property name="includeUrlProcessor">
            <ref bean="httpsIncludeUrlProcessor" />
        </property>
        <property name="portMapper">
            <ref bean="portMapper" />
        </property>
    </bean>
    
     <bean id="inSecureChannelFilter" class="com.mitian.airad.common.auth.filter.InSecureChannelFilter">
         <property name="ignoreFirst" value="true" />
         
          <property name="excludeUrlProcessor">
            <ref bean="httpsExcludeUrlProcessor" />
        </property>
        
        <property name="portMapper">
            <ref bean="portMapper" />
        </property>
    </bean>

    <!-- 线程上下文检查 -->
    <bean id="securityContextFilter" class="com.mitian.airad.common.auth.filter.SecurityContextFilter" parent="baseFilter">
        <!-- 匿名登录匹配 -->
        <property name="anonymousUrlProcessor">
            <ref bean="anonymousUrlProcessor" />
        </property>
    </bean>
    <!-- 超时检查 -->
    <bean id="timeOutCheckFilter" class="com.mitian.airad.common.auth.filter.TimeOutCheckFilter" parent="baseFilter">
        <property name="timeOutInMinute" value="60" />
        <property name="anonymousAccess" value="true" />
        <property name="lastVisitCookieGenerator">
            <ref bean="lastVisitCookieGenerator" />
        </property>
    </bean>
    
    
    
    <bean id="httpsExcludeUrlProcessor" class="com.mitian.airad.common.auth.filter.processor.DefaultExcludeUrlProcessor">
        <property name="matcher">
            <ref bean="javaMatcher" />
        </property>
        <property name="ignoreUrlList">
             <list>
                <value><![CDATA[policy\.do\?.*xcase=listView(&|$)]]></value>
                <value><![CDATA[payinsure\.do\?.*xcase=bill(&|$)]]></value>
                <value><![CDATA[payaccpremiums\.do\?.*xcase=pay(&|$)]]></value>
                <value><![CDATA[paythird\.do\?.*xcase=genAppTrans(&|$)]]></value>
            </list>
        </property>
    </bean>
    
    
    <bean id="excludeUrlProcessor" class="com.mitian.airad.common.auth.filter.processor.DefaultExcludeUrlProcessor">
        <property name="matcher">
            <ref bean="javaMatcher" />
        </property>
        <property name="ignoreUrlList">
            <list>
                <value><![CDATA[\.(css|js|jpg|gif|ico|png|json|swf)$]]></value>
                <value><![CDATA[fileuploading\.do\?.*(&|$)]]></value>
            </list>
        </property>
    </bean>
    
    
      <bean id="httpsIncludeUrlProcessor" class="com.mitian.airad.common.auth.filter.processor.DefaultIncludeUrlProcessor">
        <property name="matcher">
            <ref bean="javaMatcher" />
        </property>
        <property name="includeUrlList">
            <list>
                <value><![CDATA[policy\.do\?.*xcase=listView(&|$)]]></value>
                <value><![CDATA[payinsure\.do\?.*xcase=bill(&|$)]]></value>
                <value><![CDATA[payaccpremiums\.do\?.*xcase=pay(&|$)]]></value>
                <value><![CDATA[paythird\.do\?.*xcase=genAppTrans(&|$)]]></value>
            </list>
        </property>
    </bean>
    

    <bean id="includeUrlProcessor" class="com.mitian.airad.common.auth.filter.processor.DefaultIncludeUrlProcessor">
        <property name="matcher">
            <ref bean="javaMatcher" />
        </property>
        <property name="includeUrlList">
            <list>
                <value><![CDATA[.*]]></value>
            </list>
        </property>
    </bean>
    <bean id="anonymousUrlProcessor" class="com.mitian.airad.common.auth.filter.processor.DefaultAnonymousUrlProcessor">
        <property name="matcher">
            <ref bean="javaMatcher" />
        </property>
        <property name="anonymousUrlList">
            <list>
                <value><![CDATA[.*]]></value>
            </list>
        </property>
    </bean>
    
      <bean id="portMapper" class="com.mitian.airad.common.auth.filter.processor.DefaultPortMapper">
        <property name="httpsPortMappings">
            <map>
              <entry key="80" value="443"/>
              <entry key="8080" value="8443"/>
            </map>
        </property>
    </bean>
    <bean id="javaMatcher" class="com.mitian.airad.common.auth.compare.RegexUrlPathMatcher" />
</beans>